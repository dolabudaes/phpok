(function(R){"use strict";var l={data:undefined,lang:"cn",multiple:false,pagination:true,dropButton:true,listSize:10,multipleControlbar:true,maxSelectLimit:0,selectToCloseList:false,initRecord:undefined,dbTable:"tbl",keyField:"id",showField:"name",searchField:undefined,andOr:"AND",orderBy:false,pageSize:10,params:undefined,formatItem:undefined,autoFillResult:false,autoSelectFirst:false,noResultClean:true,selectOnly:false,inputDelay:.5,eSelect:undefined,eOpen:undefined,eAjaxSuccess:undefined,eTagRemove:undefined,eClear:undefined};var u=function(e,t){this.setOption(t);this.setLanguage();this.setCssClass();this.setProp();this.setElem(e);this.setButtonAttrDefault();this.setInitRecord();this.eDropdownButton();this.eInput();this.eWhole()};u.version="2.20";u.dataKey="selectPageObject";u.prototype.setOption=function(e){e.searchField=e.searchField||e.showField;e.andOr=e.andOr.toUpperCase();if(e.andOr!=="AND"&&e.andOr!=="OR")e.andOr="AND";var t=["searchField"];for(var a=0;a<t.length;a++){e[t[a]]=this.strToArray(e[t[a]])}if(e.orderBy!==false)e.orderBy=this.setOrderbyOption(e.orderBy,e.showField);if(e.multiple&&!e.selectToCloseList){e.autoFillResult=false;e.autoSelectFirst=false}if(!e.pagination)e.pageSize=200;if(R.type(e.listSize)!=="number"||e.listSize<0)e.listSize=10;this.option=e};u.prototype.strToArray=function(e){return e?e.replace(/[\s　]+/g,"").split(","):""};u.prototype.setOrderbyOption=function(e,t){var a=[],i=[];if(typeof e==="object"){for(var l=0;l<e.length;l++){i=R.trim(e[l]).split(" ");if(i.length){a.push(i.length===2?i.concat():[i[0],"ASC"])}}}else{i=R.trim(e).split(" ");a[0]=i.length===2?i.concat():i[0].toUpperCase().match(/^(ASC|DESC)$/i)?[t,i[0].toUpperCase()]:[i[0],"ASC"]}return a};u.prototype.setLanguage=function(){var e,t=this.option;switch(t.lang){case"de":e={add_btn:"Hinzufügen-Button",add_title:"Box hinzufügen",del_btn:"Löschen-Button",del_title:"Box löschen",next:"Nächsten",next_title:"Nächsten"+t.pageSize+" (Pfeil-rechts)",prev:"Vorherigen",prev_title:"Vorherigen"+t.pageSize+" (Pfeil-links)",first_title:"Ersten (Umschalt + Pfeil-links)",last_title:"Letzten (Umschalt + Pfeil-rechts)",get_all_btn:"alle (Pfeil-runter)",get_all_alt:"(Button)",close_btn:"Schließen (Tab)",close_alt:"(Button)",loading:"lade...",loading_alt:"(lade)",page_info:"page_num von page_count",select_ng:"Achtung: Bitte wählen Sie aus der Liste aus.",select_ok:"OK : Richtig ausgewählt.",not_found:"nicht gefunden",ajax_error:"Bei der Verbindung zum Server ist ein Fehler aufgetreten.",clear:"Löschen Sie den Inhalt",select_all:"Wähle diese Seite",unselect_all:"Diese Seite entfernen",clear_all:"Alles löschen",max_selected:"Sie können nur bis zu max_selected_limit Elemente auswählen"};break;case"en":e={add_btn:"Add button",add_title:"add a box",del_btn:"Del button",del_title:"delete a box",next:"Next",next_title:"Next"+t.pageSize+" (Right key)",prev:"Prev",prev_title:"Prev"+t.pageSize+" (Left key)",first_title:"First (Shift + Left key)",last_title:"Last (Shift + Right key)",get_all_btn:"Get All (Down key)",get_all_alt:"(button)",close_btn:"Close (Tab key)",close_alt:"(button)",loading:"loading...",loading_alt:"(loading)",page_info:"Page page_num of page_count",select_ng:"Attention : Please choose from among the list.",select_ok:"OK : Correctly selected.",not_found:"not found",ajax_error:"An error occurred while connecting to server.",clear:"Clear content",select_all:"Select current page",unselect_all:"Clear current page",clear_all:"Clear all selected",max_selected:"You can only select up to max_selected_limit items"};break;case"es":e={add_btn:"Agregar boton",add_title:"Agregar una opcion",del_btn:"Borrar boton",del_title:"Borrar una opcion",next:"Siguiente",next_title:"Proximas "+t.pageSize+" (tecla derecha)",prev:"Anterior",prev_title:"Anteriores "+t.pageSize+" (tecla izquierda)",first_title:"Primera (Shift + Left)",last_title:"Ultima (Shift + Right)",get_all_btn:"Ver todos (tecla abajo)",get_all_alt:"(boton)",close_btn:"Cerrar (tecla TAB)",close_alt:"(boton)",loading:"Cargando...",loading_alt:"(Cargando)",page_info:"page_num de page_count",select_ng:"Atencion: Elija una opcion de la lista.",select_ok:"OK: Correctamente seleccionado.",not_found:"no encuentre",ajax_error:"Un error ocurrió mientras conectando al servidor.",clear:"Borrar el contenido",select_all:"Elija esta página",unselect_all:"Borrar esta página",clear_all:"Borrar todo marcado",max_selected:"Solo puedes seleccionar hasta max_selected_limit elementos"};break;case"pt-br":e={add_btn:"Adicionar botão",add_title:"Adicionar uma caixa",del_btn:"Apagar botão",del_title:"Apagar uma caixa",next:"Próxima",next_title:"Próxima "+t.pageSize+" (tecla direita)",prev:"Anterior",prev_title:"Anterior "+t.pageSize+" (tecla esquerda)",first_title:"Primeira (Shift + Left)",last_title:"Última (Shift + Right)",get_all_btn:"Ver todos (Seta para baixo)",get_all_alt:"(botão)",close_btn:"Fechar (tecla TAB)",close_alt:"(botão)",loading:"Carregando...",loading_alt:"(Carregando)",page_info:"page_num de page_count",select_ng:"Atenção: Escolha uma opção da lista.",select_ok:"OK: Selecionado Corretamente.",not_found:"não encontrado",ajax_error:"Um erro aconteceu enquanto conectando a servidor.",clear:"Limpe o conteúdo",select_all:"Selecione a página atual",unselect_all:"Remova a página atual",clear_all:"Limpar tudo",max_selected:"Você só pode selecionar até max_selected_limit itens"};break;case"ja":e={add_btn:"追加ボタン",add_title:"入力ボックスを追加します",del_btn:"削除ボタン",del_title:"入力ボックスを削除します",next:"次へ",next_title:"次の"+t.pageSize+"件 (右キー)",prev:"前へ",prev_title:"前の"+t.pageSize+"件 (左キー)",first_title:"最初のページへ (Shift + 左キー)",last_title:"最後のページへ (Shift + 右キー)",get_all_btn:"全件取得 (下キー)",get_all_alt:"画像:ボタン",close_btn:"閉じる (Tabキー)",close_alt:"画像:ボタン",loading:"読み込み中...",loading_alt:"画像:読み込み中...",page_info:"page_num 件 (全 page_count 件)",select_ng:"注意 : リストの中から選択してください",select_ok:"OK : 正しく選択されました。",not_found:"(0 件)",ajax_error:"サーバとの通信でエラーが発生しました。",clear:"コンテンツをクリアする",select_all:"当ページを選びます",unselect_all:"移して当ページを割ります",clear_all:"選択した項目をクリアする",max_selected:"最多で max_selected_limit のプロジェクトを選ぶことしかできません"};break;case"cn":default:e={add_btn:"添加按钮",add_title:"添加区域",del_btn:"删除按钮",del_title:"删除区域",next:"下一页",next_title:"下"+t.pageSize+" (→)",prev:"上一页",prev_title:"上"+t.pageSize+" (←)",first_title:"首页 (Shift + ←)",last_title:"尾页 (Shift + →)",get_all_btn:"获得全部 (↓)",get_all_alt:"(按钮)",close_btn:"关闭 (Tab键)",close_alt:"(按钮)",loading:"读取中...",loading_alt:"(读取中)",page_info:"第 page_num 页(共page_count页)",select_ng:"请注意：请从列表中选择.",select_ok:"OK : 已经选择.",not_found:"无查询结果",ajax_error:"连接到服务器时发生错误！",clear:"清除内容",select_all:"选择当前页项目",unselect_all:"取消选择当前页项目",clear_all:"清除全部已选择项目",max_selected:"最多只能选择 max_selected_limit 个项目"};break}this.message=e};u.prototype.setCssClass=function(){var e={container:"sp_container",container_open:"sp_container_open",re_area:"sp_result_area",result_open:"sp_result_area_open",control_box:"sp_control_box",element_box:"sp_element_box",navi:"sp_navi",results:"sp_results",re_off:"sp_results_off",select:"sp_over",select_ok:"sp_select_ok",select_ng:"sp_select_ng",selected:"sp_selected",input_off:"sp_input_off",message_box:"sp_message_box",disabled:"sp_disabled",button:"sp_button",caret_open:"sp_caret_open",btn_on:"sp_btn_on",btn_out:"sp_btn_out",input:"sp_input",clear_btn:"sp_clear_btn",align_right:"sp_align_right"};this.css_class=e};u.prototype.setProp=function(){this.prop={disabled:false,current_page:1,max_page:1,is_loading:false,xhr:false,key_paging:false,key_select:false,prev_value:"",selected_text:"",last_input_time:undefined,init_set:false};this.template={tag:{content:'<li class="selected_tag" itemvalue="#item_value#">#item_text#<span class="tag_close"><i class="sp-iconfont if-close"></i></span></li>',textKey:"#item_text#",valueKey:"#item_value#"},page:{current:"page_num",total:"page_count"},msg:{maxSelectLimit:"max_selected_limit"}}};u.prototype.elementRealSize=function(e,t){var a={absolute:false,clone:false,includeMargin:false,display:"block"};var i=a,l=e.eq(0),n,o,s=[],r="",c;n=function(){c=l.parents().addBack().filter(":hidden");r+="visibility: hidden !important; display: "+i.display+" !important; ";if(i.absolute===true)r+="position: absolute !important;";c.each(function(){var e=R(this),t=e.attr("style");s.push(t);e.attr("style",t?t+";"+r:r)})};o=function(){c.each(function(e){var t=R(this),a=s[e];if(a===undefined)t.removeAttr("style");else t.attr("style",a)})};n();var p=/(outer)/.test(t)?l[t](i.includeMargin):l[t]();o();return p};u.prototype.setElem=function(e){var t={},a=this.option,i=this.css_class,l=this.message,n=R(e);var o=n.outerWidth();if(o<=0)o=this.elementRealSize(n,"outerWidth");if(o<150)o=150;t.combo_input=n.attr({autocomplete:"off"}).addClass(i.input).wrap("<div>");if(a.selectOnly)t.combo_input.prop("readonly",true);t.container=t.combo_input.parent().addClass(i.container);if(t.combo_input.prop("disabled")){if(a.multiple)t.container.addClass(i.disabled);else t.combo_input.addClass(i.input_off)}t.container.width(o);t.button=R("<div>").addClass(i.button);t.dropdown=R('<span class="sp_caret"></span>');t.clear_btn=R("<div>").html(R("<i>").addClass("sp-iconfont if-close")).addClass(i.clear_btn).attr("title",l.clear);if(!a.dropButton)t.clear_btn.addClass(i.align_right);t.element_box=R("<ul>").addClass(i.element_box);if(a.multiple&&a.multipleControlbar)t.control=R("<div>").addClass(i.control_box);t.result_area=R("<div>").addClass(i.re_area);if(a.pagination)t.navi=R("<div>").addClass("sp_pagination").append("<ul>");t.results=R("<ul>").addClass(i.results);var s="_text",r=t.combo_input.attr("id")||t.combo_input.attr("name"),c=t.combo_input.attr("name")||"selectPage",p=c,u=r;t.hidden=R('<input type="hidden" class="sp_hidden" />').attr({name:p,id:u}).val("");t.combo_input.attr({name:c+s,id:r+s});t.container.append(t.hidden);if(a.dropButton){t.container.append(t.button);t.button.append(t.dropdown)}R(document.body).append(t.result_area);t.result_area.append(t.results);if(a.pagination)t.result_area.append(t.navi);if(a.multiple){if(a.multipleControlbar){t.control.append('<button type="button" class="btn btn-default sp_clear_all" ><i class="sp-iconfont if-clear"></i></button>');t.control.append('<button type="button" class="btn btn-default sp_unselect_all" ><i class="sp-iconfont if-unselect-all"></i></button>');t.control.append('<button type="button" class="btn btn-default sp_select_all" ><i class="sp-iconfont if-select-all"></i></button>');t.control_text=R("<p>");t.control.append(t.control_text);t.result_area.prepend(t.control)}t.container.addClass("sp_container_combo");t.combo_input.addClass("sp_combo_input").before(t.element_box);var d=R("<li>").addClass("input_box");d.append(t.combo_input);t.element_box.append(d);if(t.combo_input.attr("placeholder"))t.combo_input.attr("placeholder_bak",t.combo_input.attr("placeholder"))}this.elem=t};u.prototype.setButtonAttrDefault=function(){if(this.option.dropButton)this.elem.button.attr("title",this.message.close_btn)};u.prototype.setInitRecord=function(e){var a=this,i=a.option,t=a.elem,l="";if(R.type(t.combo_input.data("init"))!="undefined"){i.initRecord=String(t.combo_input.data("init"))}if(!e&&!i.initRecord&&t.combo_input.val()){i.initRecord=t.combo_input.val()}t.combo_input.val("");if(!e){t.hidden.val(i.initRecord)}l=e&&t.hidden.val()?t.hidden.val():i.initRecord;if(l){if(typeof i.data==="object"){var n=new Array;var o=l.split(",");R.each(o,function(e,t){for(var a=0;a<i.data.length;a++){if(i.data[a][i.keyField]==t){n.push(i.data[a]);break}}});if(!i.multiple&&n.length>1)n=[n[0]];a.afterInit(a,n)}else{R.ajax({dataType:"json",type:"POST",url:i.data,data:{searchTable:i.dbTable,searchKey:i.keyField,searchValue:l},success:function(e){var t=null;if(i.eAjaxSuccess&&R.isFunction(i.eAjaxSuccess))t=i.eAjaxSuccess(e);a.afterInit(a,t.list)},error:function(){a.ajaxErrorNotify(a)}})}}};u.prototype.afterInit=function(i,e){if(!e||R.isArray(e)&&e.length===0)return;if(!R.isArray(e))e=[e];var l=i.option,t=i.css_class;var n=function(e){var t=e[l.showField];if(l.formatItem&&R.isFunction(l.formatItem)){try{t=l.formatItem(e)}catch(e){}}return t};if(l.multiple){i.prop.init_set=true;R.each(e,function(e,t){var a={text:n(t),value:t[l.keyField]};if(i.isAlreadySelected(i,a))i.addNewTag(i,t,a)});i.tagValuesSet(i);i.inputResize(i);i.prop.init_set=false}else{var a={};for(var o in e){if(e[o][l.keyField]==l.initRecord){a=e[o];break}}i.elem.combo_input.val(n(a));i.elem.hidden.val(a[l.keyField]);i.prop.prev_value=n(a);i.prop.selected_text=n(a);if(l.selectOnly){i.elem.combo_input.attr("title",i.message.select_ok).removeClass(t.select_ng).addClass(t.select_ok)}i.putClearButton()}};u.prototype.eDropdownButton=function(){var t=this;if(t.option.dropButton){t.elem.button.mouseup(function(e){e.stopPropagation();if(t.elem.result_area.is(":hidden")&&!t.elem.combo_input.prop("disabled")){t.elem.combo_input.focus()}else t.hideResults(t)})}};u.prototype.eInput=function(){var a=this,i=a.option,l=a.elem,e=a.message;var n=function(){a.prop.page_move=false;a.suggest(a);a.setCssFocusedInput(a)};l.combo_input.keyup(function(e){a.processKey(a,e)}).keydown(function(e){a.processControl(a,e)}).focus(function(e){if(l.result_area.is(":hidden")){e.stopPropagation();a.prop.first_show=true;n()}});l.container.on("click.SelectPage","div."+a.css_class.clear_btn,function(e){e.stopPropagation();if(!a.disabled(a)){a.clearAll(a,true);if(i.eClear&&R.isFunction(i.eClear))i.eClear(a)}});l.result_area.on("mousedown.SelectPage",function(e){e.stopPropagation()});if(i.multiple){if(i.multipleControlbar){l.control.find(".sp_select_all").on("click.SelectPage",function(){a.selectAllLine(a)}).hover(function(){l.control_text.html(e.select_all)},function(){l.control_text.html("")});l.control.find(".sp_unselect_all").on("click.SelectPage",function(){a.unSelectAllLine(a)}).hover(function(){l.control_text.html(e.unselect_all)},function(){l.control_text.html("")});l.control.find(".sp_clear_all").on("click.SelectPage",function(){a.clearAll(a,true)}).hover(function(){l.control_text.html(e.clear_all)},function(){l.control_text.html("")})}l.element_box.on("click.SelectPage",function(e){var t=e.target||e.srcElement;if(R(t).is("ul"))l.combo_input.focus()});l.element_box.on("click.SelectPage","span.tag_close",function(){var e=R(this).closest("li"),t=e.data("dataObj");a.removeTag(a,e);n();if(i.eTagRemove&&R.isFunction(i.eTagRemove))i.eTagRemove([t])});a.inputResize(a)}};u.prototype.eWhole=function(){var e=this,i=e.css_class;var l=function(e){e.elem.combo_input.val("");if(!e.option.multiple)e.elem.hidden.val("");e.prop.selected_text=""};R(document.body).off("mousedown.selectPage").on("mousedown.selectPage",function(e){var t=e.target||e.srcElement;var a=R(t).closest("div."+i.container);R("div."+i.container+"."+i.container_open).each(function(){if(this==a[0])return;var e=R(this),t=e.find("input."+i.input).data(u.dataKey);if(!t.elem.combo_input.val()&&t.elem.hidden.val()&&!t.option.multiple){t.prop.current_page=1;l(t);t.hideResults(t);return true}if(t.elem.results.find("li").not("."+i.message_box).length){if(t.option.autoFillResult){if(t.elem.hidden.val())t.hideResults(t);else if(t.elem.results.find("li.sp_over").length){t.selectCurrentLine(t)}else if(t.option.autoSelectFirst){t.nextLine(t);t.selectCurrentLine(t)}else t.hideResults(t)}else t.hideResults(t)}else{if(t.option.noResultClean)l(t);else{if(!t.option.multiple)t.elem.hidden.val("")}t.hideResults(t)}})})};u.prototype.eResultList=function(){var t=this,a=this.css_class;t.elem.results.children("li").hover(function(){if(t.prop.key_select){t.prop.key_select=false;return}if(!R(this).hasClass(a.selected)&&!R(this).hasClass(a.message_box)){R(this).addClass(a.select);t.setCssFocusedResults(t)}},function(){R(this).removeClass(a.select)}).click(function(e){if(t.prop.key_select){t.prop.key_select=false;return}e.preventDefault();e.stopPropagation();if(!R(this).hasClass(a.selected))t.selectCurrentLine(t)})};u.prototype.eScroll=function(){var p=this.css_class;R(window).on("scroll.SelectPage",function(){R("div."+p.container+"."+p.container_open).each(function(){var e=R(this),t=e.find("input."+p.input).data(u.dataKey),a=t.elem.result_area.offset(),i=R(window).scrollTop(),l=R(document).height(),n=R(window).height(),o=t.elem.result_area.outerHeight(),s=a.top+o,r=l>n,c=t.elem.result_area.hasClass("shadowDown");if(r){if(c){if(s>n+i)t.calcResultsSize(t)}else{if(a.top<i)t.calcResultsSize(t)}}})})};u.prototype.ePaging=function(){var t=this;if(!t.option.pagination)return;t.elem.navi.find("li.csFirstPage").off("click").on("click",function(e){e.preventDefault();t.firstPage(t)});t.elem.navi.find("li.csPreviousPage").off("click").on("click",function(e){e.preventDefault();t.prevPage(t)});t.elem.navi.find("li.csNextPage").off("click").on("click",function(e){e.preventDefault();t.nextPage(t)});t.elem.navi.find("li.csLastPage").off("click").on("click",function(e){e.preventDefault();t.lastPage(t)})};u.prototype.ajaxErrorNotify=function(e){e.showMessage(e.message.ajax_error)};u.prototype.showMessage=function(e,t){if(!t)return;var a='<li class="'+e.css_class.message_box+'"><i class="sp-iconfont if-warning"></i> '+t+"</li>";e.elem.results.empty().append(a).show();e.calcResultsSize(e);e.setOpenStatus(e,true);e.elem.control.hide();if(e.option.pagination)e.elem.navi.hide()};u.prototype.scrollWindow=function(e,t){var a=e.getCurrentLine(e);var i;var l=a&&!t?a.offset().top:e.elem.container.offset().top;e.prop.size_li=e.elem.results.children("li:first").outerHeight();i=e.prop.size_li;var n;var o=R(window).height();var s=R(window).scrollTop();var r=s+o-i;if(a.length){if(l<s||i>o){n=l-s}else if(l>r){n=l-r}else return}else if(l<s)n=l-s;window.scrollBy(0,n)};u.prototype.setOpenStatus=function(e,t){var a=e.elem,i=e.css_class;if(t){a.container.addClass(i.container_open);a.result_area.addClass(i.result_open)}else{a.container.removeClass(i.container_open);a.result_area.removeClass(i.result_open)}};u.prototype.setCssFocusedInput=function(e){};u.prototype.setCssFocusedResults=function(e){};u.prototype.checkValue=function(e){var t=e.elem.combo_input.val();if(t!=e.prop.prev_value){e.prop.prev_value=t;e.prop.first_show=false;if(e.option.selectOnly)e.setButtonAttrDefault();if(!e.option.multiple&&!t){e.elem.combo_input.val("");e.elem.hidden.val("");e.elem.clear_btn.remove()}e.suggest(e)}};u.prototype.processKey=function(e,t){if(R.inArray(t.keyCode,[37,38,39,40,27,9,13])===-1){if(t.keyCode!=16)e.setCssFocusedInput(e);e.inputResize(e);if(R.type(e.option.data)==="string"){e.prop.last_input_time=t.timeStamp;setTimeout(function(){if(t.timeStamp-e.prop.last_input_time===0)e.checkValue(e)},e.option.inputDelay*1e3)}else{e.checkValue(e)}}};u.prototype.processControl=function(e,t){if(R.inArray(t.keyCode,[37,38,39,40,27,9])>-1&&e.elem.result_area.is(":visible")||R.inArray(t.keyCode,[13,9])>-1&&e.getCurrentLine(e)){t.preventDefault();t.stopPropagation();t.cancelBubble=true;t.returnValue=false;switch(t.keyCode){case 37:if(t.shiftKey)e.firstPage(e);else e.prevPage(e);break;case 38:e.prop.key_select=true;e.prevLine(e);break;case 39:if(t.shiftKey)e.lastPage(e);else e.nextPage(e);break;case 40:if(e.elem.results.children("li").length){e.prop.key_select=true;e.nextLine(e)}else e.suggest(e);break;case 9:e.prop.key_paging=true;e.selectCurrentLine(e);break;case 13:e.selectCurrentLine(e);break;case 27:e.prop.key_paging=true;e.hideResults(e);break}}};u.prototype.abortAjax=function(e){if(e.prop.xhr){e.prop.xhr.abort();e.prop.xhr=false}};u.prototype.suggest=function(e){var t,a=R.trim(e.elem.combo_input.val());if(e.option.multiple)t=a;else{if(a&&a===e.prop.selected_text)t="";else t=a}t=t.split(/[\s　]+/);if(e.option.eOpen&&R.isFunction(e.option.eOpen))e.option.eOpen.call(e);e.abortAjax(e);var i=e.prop.current_page||1;if(typeof e.option.data=="object")e.searchForJson(e,t,i);else e.searchForDb(e,t,i)};u.prototype.setLoading=function(e){if(e.elem.results.html()===""){e.setOpenStatus(e,true)}};u.prototype.searchForDb=function(n,o,s){var r=n.option;if(!r.eAjaxSuccess||!R.isFunction(r.eAjaxSuccess))n.hideResults(n);var e=r.params,t={},a=r.searchField;if(o.length&&o[0]&&o[0]!==n.prop.prev_value)s=1;var i={q_word:o,pageNumber:s,pageSize:r.pageSize,andOr:r.andOr,searchTable:r.dbTable};if(r.orderBy!==false)i.orderBy=r.orderBy;i[a]=o[0];if(e&&R.isFunction(e)){var l=e.call(n);if(l&&R.isPlainObject(l)){t=R.extend({},i,l)}else t=i}else t=i;n.prop.xhr=R.ajax({dataType:"json",url:r.data,type:"POST",data:t,success:function(e){if(!e||!R.isPlainObject(e)){n.hideResults(n);n.ajaxErrorNotify(n);return}var t={},a={};try{t=r.eAjaxSuccess(e);a.originalResult=t.list;a.cnt_whole=t.totalRow}catch(e){n.showMessage(n,n.message.ajax_error);return}a.candidate=[];a.keyField=[];if(typeof a.originalResult!="object"){n.prop.xhr=null;n.notFoundSearch(n);return}a.cnt_page=a.originalResult.length;for(var i=0;i<a.cnt_page;i++){for(var l in a.originalResult[i]){if(l==r.keyField){a.keyField.push(a.originalResult[i][l])}if(l==r.showField){a.candidate.push(a.originalResult[i][l])}}}n.prepareResults(n,a,o,s)},error:function(e,t){if(t!="abort"){n.hideResults(n);n.ajaxErrorNotify(n)}},complete:function(){n.prop.xhr=null}})};u.prototype.searchForJson=function(e,t,a){var i=e.option,l=[],n=[],o=[],s={},r=0,c=[];do{n[r]=t[r].replace(/\W/g,"\\$&").toString();c[r]=new RegExp(n[r],"gi");r++}while(r<t.length);for(r=0;r<i.data.length;r++){var p=false,u=i.data[r],d;for(var f=0;f<c.length;f++){d=u[i.searchField];if(i.formatItem&&R.isFunction(i.formatItem))d=i.formatItem(u);if(d.match(c[f])){p=true;if(i.andOr=="OR")break}else{p=false;if(i.andOr=="AND")break}}if(p)l.push(u)}if(i.orderBy===false)o=l.concat();else{var _=new RegExp("^"+n[0]+"$","gi"),m=new RegExp("^"+n[0],"gi"),g=[],h=[],v=[];for(r=0;r<l.length;r++){var b=i.orderBy[0][0];var y=String(l[r][b]);if(y.match(_)){g.push(l[r])}else if(y.match(m)){h.push(l[r])}else{v.push(l[r])}}if(i.orderBy[0][1].match(/^asc$/i)){g=e.sortAsc(e,g);h=e.sortAsc(e,h);v=e.sortAsc(e,v)}else{g=e.sortDesc(e,g);h=e.sortDesc(e,h);v=e.sortDesc(e,v)}o=o.concat(g).concat(h).concat(v)}s.cnt_whole=o.length;if(!e.prop.page_move){if(!i.multiple){var x=e.elem.hidden.val();if(R.type(x)!=="undefined"&&R.trim(x)!==""){var C=0;R.each(o,function(e,t){if(t[i.keyField]==x){C=e+1;return false}});a=Math.ceil(C/i.pageSize);if(a<1)a=1;e.prop.current_page=a}}}else{if(o.length<=(a-1)*i.pageSize){a=1;e.prop.current_page=1}}var S=(a-1)*i.pageSize,k=S+i.pageSize;s.originalResult=[];for(r=S;r<k;r++){if(o[r]===undefined)break;s.originalResult.push(o[r]);for(var w in o[r]){if(w==i.keyField){if(s.keyField===undefined)s.keyField=[];s.keyField.push(o[r][w])}if(w==i.showField){if(s.candidate===undefined)s.candidate=[];s.candidate.push(o[r][w])}}}if(s.candidate===undefined)s.candidate=[];s.cnt_page=s.candidate.length;e.prepareResults(e,s,t,a)};u.prototype.sortAsc=function(l,e){e.sort(function(e,t){var a=e[l.option.orderBy[0][0]],i=t[l.option.orderBy[0][0]];return R.type(a)==="number"?a-i:String(a).localeCompare(String(i))});return e};u.prototype.sortDesc=function(l,e){e.sort(function(e,t){var a=e[l.option.orderBy[0][0]],i=t[l.option.orderBy[0][0]];return R.type(a)==="number"?i-a:String(i).localeCompare(String(a))});return e};u.prototype.notFoundSearch=function(e){e.elem.results.empty();e.calcResultsSize(e);e.setOpenStatus(e,true);e.setCssFocusedInput(e)};u.prototype.prepareResults=function(e,t,a,i){if(e.option.pagination)e.setNavi(e,t.cnt_whole,t.cnt_page,i);if(!t.keyField)t.keyField=false;if(e.option.selectOnly&&t.candidate.length===1&&t.candidate[0]==a[0]){e.elem.hidden.val(t.keyField[0]);this.setButtonAttrDefault()}var l=false;if(a&&a.length&&a[0])l=true;e.displayResults(e,t,l)};u.prototype.setNavi=function(e,t,a,i){var c=e.message;var l=function(t,e,a,i){var l=function(){var e=c.page_info;return e.replace(t.template.page.current,a).replace(t.template.page.total,i)};if(e.find("li").length===0){e.hide().empty();var n="sp-iconfont if-first",o="sp-iconfont if-previous",s="sp-iconfont if-next",r="sp-iconfont if-last";e.append('<li class="csFirstPage" title="'+c.first_title+'" ><a href="javascript:void(0);"> <i class="'+n+'"></i> </a></li>');e.append('<li class="csPreviousPage" title="'+c.prev_title+'" ><a href="javascript:void(0);"><i class="'+o+'"></i></a></li>');e.append('<li class="pageInfoBox"><a href="javascript:void(0);"> '+l()+" </a></li>");e.append('<li class="csNextPage" title="'+c.next_title+'" ><a href="javascript:void(0);"><i class="'+s+'"></i></a></li>');e.append('<li class="csLastPage" title="'+c.last_title+'" ><a href="javascript:void(0);"> <i class="'+r+'"></i> </a></li>');e.show()}else{e.find("li.pageInfoBox a").html(l())}};var n=e.elem.navi.find("ul"),o=Math.ceil(t/e.option.pageSize);if(o===0)i=0;else{if(o<i)i=o;else if(i===0)i=1}e.prop.current_page=i;e.prop.max_page=o;l(e,n,i,o);var s="disabled",r=n.find("li.csFirstPage"),p=n.find("li.csPreviousPage"),u=n.find("li.csNextPage"),d=n.find("li.csLastPage");if(i===1||i===0){if(!r.hasClass(s))r.addClass(s);if(!p.hasClass(s))p.addClass(s)}else{if(r.hasClass(s))r.removeClass(s);if(p.hasClass(s))p.removeClass(s)}if(i===o||o===0){if(!u.hasClass(s))u.addClass(s);if(!d.hasClass(s))d.addClass(s)}else{if(u.hasClass(s))u.removeClass(s);if(d.hasClass(s))d.removeClass(s)}if(o>1)e.ePaging()};u.prototype.displayResults=function(e,t,a){var i=e.option,l=e.elem;l.results.hide().empty();if(i.multiple&&R.type(i.maxSelectLimit)==="number"&&i.maxSelectLimit>0){var n=l.element_box.find("li.selected_tag").length;if(n>0&&n>=i.maxSelectLimit){var o=e.message.max_selected;e.showMessage(e,o.replace(e.template.msg.maxSelectLimit,i.maxSelectLimit));return}}if(t.candidate.length){var s=t.candidate,r=t.keyField,c=l.hidden.val(),p=c?c.split(","):new Array,u="";for(var d=0;d<s.length;d++){if(i.formatItem&&R.isFunction(i.formatItem)){try{u=i.formatItem(t.originalResult[d])}catch(e){console.error("formatItem 内容格式化函数内容设置不正确！");u=s[d]}}else{u=s[d]}var f=R("<li>").html(u).attr({pkey:r[d]});if(!i.formatItem)f.attr("title",u);if(R.inArray(r[d].toString(),p)!==-1){f.addClass(e.css_class.selected)}f.data("dataObj",t.originalResult[d]);l.results.append(f)}}else{var _='<li class="'+e.css_class.message_box+'"><i class="sp-iconfont if-warning"></i> '+e.message.not_found+"</li>";l.results.append(_)}l.results.show();if(i.multiple&&i.multipleControlbar)l.control.show();if(i.pagination)l.navi.show();e.calcResultsSize(e);e.setOpenStatus(e,true);e.eResultList();e.eScroll();if(a&&t.candidate.length&&i.autoSelectFirst)e.nextLine(e)};u.prototype.calcResultsSize=function(e){var h=e.option,v=e.elem;var t=function(){if(v.container.css("position")==="static"){var e=v.combo_input.offset();v.result_area.css({top:e.top+v.combo_input.outerHeight()+"px",left:e.left+"px"})}else{var t;if(!h.pagination){var a=v.results.find("li:first").outerHeight(true);t=a*h.listSize;v.results.css({"max-height":t,"overflow-y":"auto"})}var i=R(document).width(),l=R(document).height(),n=R(window).height(),o=v.container.offset(),s=R(window).scrollTop(),r=v.result_area.outerWidth(),c=o.left,p=v.container.outerHeight(),u=o.left+r>i?c-(r-v.container.outerWidth()):c,d=o.top,f=0,_=5,m=d+p+t+_,g=l>n;t=v.result_area.outerHeight();if(d-s-_>t&&g&&m>n+s||!g&&m>n){f=o.top-t-_;v.result_area.removeClass("shadowUp shadowDown").addClass("shadowUp")}else{f=o.top+(h.multiple?v.container.outerHeight():p);v.result_area.removeClass("shadowUp shadowDown").addClass("shadowDown");f+=_}return{top:f+"px",left:u+"px"}}};if(v.result_area.is(":visible")){v.result_area.css(t())}else{var a=t();v.result_area.css(a).show(1,function(){var e=t();if(a.top!==e.top||a.left!==e.left)v.result_area.css(e)})}};u.prototype.hideResults=function(e){if(e.prop.key_paging){e.scrollWindow(e,true);e.prop.key_paging=false}e.setCssFocusedInput(e);if(e.option.autoFillResult){}e.elem.results.empty();e.elem.result_area.hide();e.setOpenStatus(e,false);R(window).off("scroll.SelectPage");e.abortAjax(e);e.setButtonAttrDefault()};u.prototype.disabled=function(e,t){var a=e.elem;if(R.type(t)==="undefined")return a.combo_input.prop("disabled");if(R.type(t)==="boolean"){a.combo_input.prop("disabled",t);if(t)a.container.addClass(e.css_class.disabled);else a.container.removeClass(e.css_class.disabled)}};u.prototype.firstPage=function(e){if(e.prop.current_page>1){e.prop.current_page=1;e.prop.page_move=true;e.suggest(e)}};u.prototype.prevPage=function(e){if(e.prop.current_page>1){e.prop.current_page--;e.prop.page_move=true;e.suggest(e)}};u.prototype.nextPage=function(e){if(e.prop.current_page<e.prop.max_page){e.prop.current_page++;e.prop.page_move=true;e.suggest(e)}};u.prototype.lastPage=function(e){if(e.prop.current_page<e.prop.max_page){e.prop.current_page=e.prop.max_page;e.prop.page_move=true;e.suggest(e)}};u.prototype.afterAction=function(e,t){e.inputResize(e);e.elem.combo_input.change();e.setCssFocusedInput(e);if(e.prop.init_set)return;if(e.option.multiple){if(e.option.selectToCloseList){e.hideResults(e);e.elem.combo_input.blur()}if(!e.option.selectToCloseList&&t){e.suggest(e);e.elem.combo_input.focus()}}else{e.hideResults(e);e.elem.combo_input.blur()}};u.prototype.selectCurrentLine=function(e){e.scrollWindow(e,true);var t=e.option,a=e.getCurrentLine(e);if(a){var i=a.data("dataObj");if(t.multiple){e.elem.combo_input.val("");var l={text:a.text(),value:a.attr("pkey")};if(!e.isAlreadySelected(e,l)){e.addNewTag(e,i,l);e.tagValuesSet(e)}}else{e.elem.combo_input.val(a.text());e.elem.combo_input.data("dataObj",i);e.elem.hidden.val(a.attr("pkey"))}if(t.selectOnly)e.setButtonAttrDefault();if(t.eSelect&&R.isFunction(t.eSelect))t.eSelect(i,e);e.prop.prev_value=e.elem.combo_input.val();e.prop.selected_text=e.elem.combo_input.val();e.putClearButton()}e.afterAction(e,true)};u.prototype.putClearButton=function(){if(!this.option.multiple&&!this.elem.combo_input.prop("disabled")){this.elem.container.append(this.elem.clear_btn)}};u.prototype.selectAllLine=function(n){var o=n.option,s=new Array;n.elem.results.find("li").each(function(e,t){var a=R(t),i=a.data("dataObj");var l={text:a.text(),value:a.attr("pkey")};if(!n.isAlreadySelected(n,l)){n.addNewTag(n,i,l);n.tagValuesSet(n)}s.push(i);if(R.type(o.maxSelectLimit)==="number"&&o.maxSelectLimit>0&&o.maxSelectLimit===n.elem.element_box.find("li.selected_tag").length){return false}});if(o.eSelect&&R.isFunction(o.eSelect))o.eSelect(s,n);n.afterAction(n,true)};u.prototype.unSelectAllLine=function(l){var e=l.option,n=[];l.elem.results.find("li").each(function(e,t){var a=R(t).attr("pkey");var i=l.elem.element_box.find('li.selected_tag[itemvalue="'+a+'"]');if(i.length)n.push(i.data("dataObj"));l.removeTag(l,i)});l.afterAction(l,true);if(e.eTagRemove&&R.isFunction(e.eTagRemove))e.eTagRemove(n)};u.prototype.clearAll=function(e,t){var a=e.option,i=[];if(a.multiple){e.elem.element_box.find("li.selected_tag").each(function(e,t){i.push(R(t).data("dataObj"));t.remove()});e.elem.element_box.find("li.selected_tag").remove()}else{R(e.elem.combo_input).removeData("dataObj")}e.reset(e);e.afterAction(e,t);if(a.multiple){if(a.eTagRemove&&R.isFunction(a.eTagRemove))a.eTagRemove(i)}else e.elem.clear_btn.remove()};u.prototype.reset=function(e){e.elem.combo_input.val("");e.elem.hidden.val("");e.prop.prev_value="";e.prop.selected_text="";e.prop.current_page=1};u.prototype.getCurrentLine=function(e){if(e.elem.result_area.is(":hidden"))return false;var t=e.elem.results.find("li."+e.css_class.select);return t.length?t:false};u.prototype.isAlreadySelected=function(e,t){var a=false;if(t.value){var i=e.elem.hidden.val();if(i){var l=i.split(",");if(l&&l.length&&R.inArray(t.value,l)!=-1)a=true}}return a};u.prototype.addNewTag=function(e,t,a){if(!e.option.multiple||!t||!a)return;var i=e.template.tag.content,l;i=i.replace(e.template.tag.textKey,a.text);i=i.replace(e.template.tag.valueKey,a.value);l=R(i);l.data("dataObj",t);if(e.elem.combo_input.prop("disabled")){l.find("span.tag_close").hide()}e.elem.combo_input.closest("li").before(l)};u.prototype.removeTag=function(e,t){var a=R(t).attr("itemvalue");var i=e.elem.hidden.val();if(R.type(a)!="undefined"&&i){var l=i.split(","),n=R.inArray(a.toString(),l);if(n!=-1){l.splice(n,1);e.elem.hidden.val(l.toString())}}R(t).remove();e.inputResize(e)};u.prototype.tagValuesSet=function(e){if(!e.option.multiple)return;var t=e.elem.element_box.find("li.selected_tag");if(t&&t.length){var i=new Array;R.each(t,function(e,t){var a=R(t).attr("itemvalue");if(R.type(a)!=="undefined")i.push(a)});if(i.length){e.elem.hidden.val(i.join(","))}}};u.prototype.inputResize=function(e){if(!e.option.multiple)return;var t=e.elem.combo_input.closest("li");var a=function(e,t){t.removeClass("full_width");var a=e.elem.combo_input.val().length+1,i=a*.75+"em";e.elem.combo_input.css("width",i).removeAttr("placeholder")};if(e.elem.element_box.find("li.selected_tag").length===0){if(e.elem.combo_input.attr("placeholder_bak")){if(!t.hasClass("full_width"))t.addClass("full_width");e.elem.combo_input.attr("placeholder",e.elem.combo_input.attr("placeholder_bak")).removeAttr("style")}else a(e,t)}else a(e,t)};u.prototype.nextLine=function(e){var t=e.getCurrentLine(e),a;if(!t){a=-1}else{a=e.elem.results.children("li").index(t);t.removeClass(e.css_class.select)}a++;if(a<e.elem.results.children("li").length){var i=e.elem.results.children("li").eq(a);i.addClass(e.css_class.select);e.setCssFocusedResults(e)}else{e.setCssFocusedInput(e)}e.scrollWindow(e,false)};u.prototype.prevLine=function(e){var t=e.getCurrentLine(e),a;if(!t)a=e.elem.results.children("li").length;else{a=e.elem.results.children("li").index(t);t.removeClass(e.css_class.select)}a--;if(a>-1){var i=e.elem.results.children("li").eq(a);i.addClass(e.css_class.select);e.setCssFocusedResults(e)}else e.setCssFocusedInput(e);e.scrollWindow(e,false)};function e(i){return this.each(function(){var e=R(this),t=e.data(u.dataKey),a=R.extend({},l,e.data(),t&&t.option,typeof i==="object"&&i);if(!t)e.data(u.dataKey,t=new u(this,a))})}function n(e){return R(e).closest("div.sp_container").find("input.sp_input")}function t(){return this.each(function(){var e=n(this),t=e.data(u.dataKey);if(t){t.prop.init_set=true;t.clearAll(t);t.prop.init_set=false}})}function a(){return this.each(function(){var e=n(this),t=e.data(u.dataKey);if(t&&t.elem.hidden.val())t.setInitRecord(true)})}function i(a){return this.each(function(){if(a&&R.isArray(a)){var e=n(this),t=e.data(u.dataKey);if(t){t.clearAll(t);t.option.data=a}}})}function o(a){var i=false;this.each(function(){var e=n(this),t=e.data(u.dataKey);if(t){if(R.type(a)!=="undefined")t.disabled(t,a);else i=t.disabled(t)}});return i}function s(){var i="";this.each(function(){var e=n(this),t=e.data(u.dataKey);if(t){if(t.option.multiple){var a=[];t.elem.element_box.find("li.selected_tag").each(function(e,t){a.push(R(t).text())});i+=a.toString()}else i+=t.elem.combo_input.val()}});return i}function r(){var i=[];this.each(function(){var e=n(this),t=e.data(u.dataKey);if(t){if(t.option.multiple){t.elem.element_box.find("li.selected_tag").each(function(e,t){i.push(R(t).data("dataObj"))})}else{var a=t.elem.combo_input.data("dataObj");if(a)i.push(a)}}});return i}var c=R.fn.selectPage;R.fn.selectPage=e;R.fn.selectPage.Constructor=u;R.fn.selectPageClear=t;R.fn.selectPageRefresh=a;R.fn.selectPageData=i;R.fn.selectPageDisabled=o;R.fn.selectPageText=s;R.fn.selectPageSelectedData=r;R.fn.selectPage.noConflict=function(){R.fn.selectPage=c;return this}})(window.jQuery);